# Queue app

Отчет о реализации системы обработки задач.

### Функциональность

### 1. Очередь на обработку задач

- Человек подходит к терминалу, который отправляет `POST /task`, получая номер в очереди.
- Оператор получает следующую задачу в статусе `WAITING`, вызывая `GET /task`.
- Оператор обновляет статус задачи по номеру `PATCH /task/number`.
- Оператор может удалить задачу `DELETE /task/number`.
- Экран отображает задачи по статусам (кроме `CLOSE`), используя `GET /tasks`.

### 2. Объекты

#### Task

```java
class Task {
    String number;  // Уникальный идентификатор (цифры и буквы)
    TaskStatus status; 
    List<TaskStatusTime> times; // История времени по статусам
}
```

#### TaskStatus

```java
class TaskStatus {
    Map<TaskStatus, List<String>> statusMap; // Список задач по статусам
}
```

#### TaskStatusTimeMap

```java
class TaskStatusTimeMap {
    List<TaskStatusTime> times; // Время обработки по статусам
}
```

### 3. Логика смены статусов

- **NEW → WAITING → PROCESSED → CLOSE**
- Задача может перейти в статус `CANCEL` из любого состояния.
- Разрешен переход на шаг вперед или назад.
- Если задача из `PROCESSED` переводится в `WAITING`, она ставится в конец очереди.

### 4. Очередь

- Используется `ConcurrentLinkedQueue` для обработки очереди.

## API для менеджера

### 1. Среднее время обработки задач

- `GET /times` → возвращает `TaskStatusTimeMap`

### 2. Время обработки конкретной задачи

- `GET /times/{number}` → возвращает `Double` (время обработки задачи)

### 3. Время обработки по статусу задачи

- `GET /times/{number}/{status}` → возвращает `Double` (время обработки задачи в конкретном статусе)

### 4. Среднее время обработки по статусам

- `GET /times/status` → возвращает `TaskStatusTimeMap`

## Дополнительные требования

- **Использование:** `MapStruct`, `Swagger`, `Lombok`
- **Покрытие тестами:** >90%
- \*\*Автоматический переход в \*\*\`\` для задач, находящихся в статусе, отличном от `NEW`, дольше 30 минут (проверка каждую минуту по `cron`).

## Реализация в проекте

### 1. Файл `service/TaskStatusChecker.java`

- Отвечает за обработку таймаутов и перевод задач в `CANCEL`.

### 2. Swagger-документация (`swagger.yml`)

- Описаны API-интерфейсы.
- В `resources/definitions` хранятся DTO.
- Используется `swagger-codegen` для генерации API и DTO.

### 3. Реализация SOAP-сервиса

- Контракт в `resources/xsd/soap.xsd`.
- Используется `jaxb2-maven-plugin` (`goal xjc`).
- Ошибки передаются через `Fault`.
- Аутентификация не настроена.

### 4. Реализация gRPC

- Контракт в `protobuf/tasks.proto`.
- Код генерируется через `protobuf-maven-plugin`.
- Аутентификация реализована через интерцептор.
- Используется `@GrpcAdvice` для обработки исключений.
- Исключения передаются как `StatusException`.
- Упрощенная архитектура (без дополнительного сервисного слоя).

### 5. Реализация безопасности (`SecurityFilterChain`)

- Доступ к `POST /task` и `GET /tasks` открыт (`permitAll`).
- Доступ к остальным эндпоинтам только для ролей `"manager"`, `"user"`.
- Пароли хранятся в `application.properties` или переменной окружения (`env`).
- Тестирование реализовано.

## Архитектура проекта

- Общие модули (`repository`, `exceptions`) вынесены в отдельные пакеты.
- Реализации для разных протоколов (`REST`, `SOAP`, `gRPC`) разнесены по разным пакетам.

---

## Итог

✅ Покрытие тестами выше 90%. 